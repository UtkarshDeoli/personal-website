<!DOCTYPE html>
<html lang="en" dir="ltr" class="scroll-smooth" data-default-appearance="dark"
  data-auto-appearance="true"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  
  <meta http-equiv="content-language" content="en" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  
  <title>TiDB知识点梳理 (PCTA 笔记) &middot; Utkarsh Deoli</title>
  <meta name="title" content="TiDB知识点梳理 (PCTA 笔记) &middot; Utkarsh Deoli" />
  
  <meta name="description" content="之前对看了TiDB 数据库核心原理与架构(101)，但笔记比较潦草，索性写个完整笔记，顺便追源码" />
  <meta name="keywords" content="算法原理, " />
  
  
  <link rel="canonical" href="http://localhost:1313/articels/2023-12-01/" />
  
  
  
  
  
  
  
  
  
  
  <link type="text/css" rel="stylesheet" href="/css/main.bundle.min.81c7ce66608dd0b86aa3e571076f8794993d50f0d4a5b153013edfc28642a93c4104edfdc604558908c3624b8e99386757d81f1bf8c4452c6220cf4c63970408.css"
    integrity="sha512-gcfOZmCN0Lhqo&#43;VxB2&#43;HlJk9UPDUpbFTAT7fwoZCqTxBBO39xgRViQjDYkuOmThnV9gfG/jERSxiIM9MY5cECA==" />
  
  
  <script type="text/javascript" src="/js/appearance.min.5d428d79012944375125a88085344ec5bd884b22e856048a3bace9e7c7c4ba93bbeff8218b019bb038df26621963d060ecc1f7f6c25a73aeea476386aa34937e.js"
    integrity="sha512-XUKNeQEpRDdRJaiAhTROxb2ISyLoVgSKO6zp58fEupO77/ghiwGbsDjfJmIZY9Bg7MH39sJac67qR2OGqjSTfg=="></script>
  
  
  
  
  
  <script src="/js/zoom.min.js"></script>
  
  
  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/site.webmanifest" />
  
  
  
  
  
  
  
  <meta property="og:title" content="TiDB知识点梳理 (PCTA 笔记)" />
<meta property="og:description" content="之前对看了TiDB 数据库核心原理与架构(101)，但笔记比较潦草，索性写个完整笔记，顺便追源码" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/articels/2023-12-01/" /><meta property="og:image" content="http://localhost:1313/articels/2023-12-01/feature.jpg" /><meta property="article:section" content="articels" />
<meta property="article:published_time" content="2023-12-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-12-01T00:00:00+00:00" />

  <meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/articels/2023-12-01/feature.jpg" /><meta name="twitter:title" content="TiDB知识点梳理 (PCTA 笔记)"/>
<meta name="twitter:description" content="之前对看了TiDB 数据库核心原理与架构(101)，但笔记比较潦草，索性写个完整笔记，顺便追源码"/>

  
  <script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "文章",
    "name": "TiDB知识点梳理 (PCTA 笔记)",
    "headline": "TiDB知识点梳理 (PCTA 笔记)",
    
    "abstract": "之前对看了TiDB 数据库核心原理与架构(101)，但笔记比较潦草，索性写个完整笔记，顺便追源码",
    "inLanguage": "en",
    "url" : "http:\/\/localhost:1313\/articels\/2023-12-01\/",
    "author" : {
      "@type": "Person",
      "name": "Utkarsh Deoli"
    },
    "copyrightYear": "2023",
    "dateCreated": "2023-12-01T00:00:00\u002b00:00",
    "datePublished": "2023-12-01T00:00:00\u002b00:00",
    
    "dateModified": "2023-12-01T00:00:00\u002b00:00",
    
    "keywords": ["算法原理"],
    
    "mainEntityOfPage": "true",
    "wordCount": "1416"
  }]
  </script>


  
  
  <meta name="author" content="Utkarsh Deoli" />
  
  
  
  <link href="mailto:utkarsh.deoli@gmail.com?subject=Contacting%20from%20your%20website" rel="me" />
  
  
  <link href="https://github.com/UtkarshDeoli" rel="me" />
  
  
  <link href="https://www.linkedin.com/in/utkarshdeoli" rel="me" />
  
  
  <link href="https://x.com/utkarshdeoli" rel="me" />
  
  
  <link href="https://www.youtube.com/@utkarshdeoli" rel="me" />
  
  
  <link href="https://www.leetcode.com/sagemodeutkarsh" rel="me" />
  
  
  
  

<script src="/lib/jquery/jquery.slim.min.js" integrity=""></script>















    
    <script defer src="/lib/packery/packery.pkgd.min.js" integrity=""></script>

    
    
    <script type="text/javascript" src="/js/shortcodes/gallery.min.9b4cb28f931ed922c26fb9b2510c2debb370f6a63305050c2af81740b2919883715e24efbbdf3a081496718ec751df3a72729d4d0bc71d6071297563a97ce1ee.js" integrity="sha512-m0yyj5Me2SLCb7myUQwt67Nw9qYzBQUMKvgXQLKRmINxXiTvu986CBSWcY7HUd86cnKdTQvHHWBxKXVjqXzh7g=="></script>







  
  


  
  
  <meta name="theme-color"/>
  
  
</head>
<body
  class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32">
  <div id="the-top" class="absolute flex self-center">
    <a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600"
      href="#main-content"><span
        class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a>
  </div>
  
  
  <div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
  <div id="menu-blur" class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom bg-neutral dark:bg-neutral-800"></div>
  <div class="relative max-w-[64rem] ml-auto mr-auto">
    <div style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px"
    class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3">
    
    
    
    <div>
        <a href="/" class="flex">
            <span class="sr-only">Utkarsh Deoli</span>

            <img src="/nekonobg.png" width="250" height="250"
                class="logo max-h-[5rem] max-w-[5rem] object-scale-down object-left nozoom" alt="Utkarsh Deoli" />

        </a>
    </div>
    
    <div class="flex flex-1 items-center justify-between">
        <nav class="flex space-x-3">

            
            <a href="/" class="text-base font-medium text-gray-500 hover:text-gray-900">Utkarsh Deoli</a>
            

        </nav>
        <nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">

            
            
            
  <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Projects
    </p>
</a>


            
            
  <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Blog
    </p>
</a>


            
            
  <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Contact
    </p>
</a>


            
            
  <a href="https://firebasestorage.googleapis.com/v0/b/utkarsh-deoli-portfolio.appspot.com/o/UtkarshDeoliCV%20%281%29.pdf?alt=media&amp;token=dbb3a0de-4dd5-4f17-a410-c1ceee191f75"  target="_blank"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        Resume
    </p>
</a>


            
            
  <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
    
    <p class="text-base font-medium" title="">
        
    </p>
</a>


            
            

            


            


            
            
            <div
                class="ltr:mr-14 rtl:ml-14 flex items-center">
                <button id="appearance-switcher" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400">
                    <div class="flex items-center justify-center dark:hidden">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                    </div>
                    <div class="items-center justify-center hidden dark:flex">
                        

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                    </div>
                </button>
            </div>
            

        </nav>
        <div class="flex md:hidden items-center space-x-5 md:ml-12 h-12">

            <span></span>

            


            

            
            
            <button id="appearance-switcher-mobile" aria-label="Dark mode switcher" type="button" class="text-base hover:text-primary-600 dark:hover:text-primary-400" style="margin-right:5px">
                <div class="flex items-center justify-center dark:hidden">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z"/></svg>

  </span>


                </div>
                <div class="items-center justify-center hidden dark:flex">
                    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z"/></svg>

  </span>


                </div>
            </button>
            

        </div>
    </div>
    <div class="-my-2 -mr-2 md:hidden">

        <label id="menu-button" for="menu-controller" class="block">
            <input type="checkbox" id="menu-controller" class="hidden" />
            
            <div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
                

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z"/></svg>

  </span>


            </div>
            <div id="menu-wrapper" style="padding-top:5px;"
                class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50">
                <ul
                    class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">

                    <li>
                        <span
                            class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentColor" d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z"/></svg>

  </span>

</span>
                    </li>

                    

                    
  <li class="mt-1">
    <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Projects
        </p>
    </a>
</li>



                    

                    
  <li class="mt-1">
    <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Blog
        </p>
    </a>
</li>



                    

                    
  <li class="mt-1">
    <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Contact
        </p>
    </a>
</li>



                    

                    
  <li class="mt-1">
    <a href="https://firebasestorage.googleapis.com/v0/b/utkarsh-deoli-portfolio.appspot.com/o/UtkarshDeoliCV%20%281%29.pdf?alt=media&amp;token=dbb3a0de-4dd5-4f17-a410-c1ceee191f75"  target="_blank"  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            Resume
        </p>
    </a>
</li>



                    

                    
  <li class="mt-1">
    <a href=""  class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400">
        
        <p class="text-bg font-bg" title="">
            
        </p>
    </a>
</li>



                    

                </ul>
                
                

            </div>
        </label>
    </div>
</div>




<script>
    (function () {
        var $mainmenu = $('.main-menu');
        var path = window.location.pathname;
        $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
            $(e).children('p').addClass('active');
        });
    })();
</script>


  </div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>

  
  <div class="relative flex flex-col grow">
    <main id="main-content" class="grow">
      


<article>
  
  
  
  
  
  


<div id="hero" class="h-[150px] md:h-[200px]"></div>



    
    <div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom"
    style="background-image:url(/articels/2023-12-01/feature_hu3737e3fab20c7215927378e9b964b582_213139_1200x0_resize_q75_box.jpg);">
    


    <div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
    </div>
    <div
        class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
    </div>
</div>

<div id="background-blur" class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div>
<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });
</script>

  
  

  <header id="single_header" class="mt-5 max-w-prose">
    
    <h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      TiDB知识点梳理 (PCTA 笔记)
    </h1>
    <div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
      





  
  







  





  



  



  



  



  







<div class="flex flex-row flex-wrap items-center">
  
  
  <time datetime="2023-12-01 00:00:00 &#43;0000 UTC">1 December 2023</time><span class="px-2 text-primary-500">&middot;</span><span>1416 words</span><span class="px-2 text-primary-500">&middot;</span><span title="Reading time">7 mins</span><span class="px-2 text-primary-500">&middot;</span><span>
  
  
    
    
      
      
        
        
      
      
    
  
  <span id="views_articels/2023-12-01/index.md" class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400" title="views">loading</span>
  <span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
<path fill="currentColor" d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg>
  </span>

</span>
</span><span class="px-2 text-primary-500">&middot;</span><span>
  
  
    
    
      
      
        
        
      
      
    
  
  <span id="likes_articels/2023-12-01/index.md"
    class="animate-pulse inline-block text-transparent max-h-3 rounded-full mt-[-2px] align-middle bg-neutral-300 dark:bg-neutral-400"
    title="likes">loading</span>
  <span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
<path fill="currentColor" d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
  </span>

</span>
</span><span class="px-2 text-primary-500">&middot;</span><span>
    <button id="button_likes"
        class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400"
        onclick="process_article()">
        <span id="button_likes_heart" style="display:none" class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
<path fill="currentColor" d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></svg>
  </span>

 </span>
        <span id="button_likes_emtpty_heart" class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
<path fill="currentColor" d="M244 84L255.1 96L267.1 84.02C300.6 51.37 347 36.51 392.6 44.1C461.5 55.58 512 115.2 512 185.1V190.9C512 232.4 494.8 272.1 464.4 300.4L283.7 469.1C276.2 476.1 266.3 480 256 480C245.7 480 235.8 476.1 228.3 469.1L47.59 300.4C17.23 272.1 0 232.4 0 190.9V185.1C0 115.2 50.52 55.58 119.4 44.1C164.1 36.51 211.4 51.37 244 84C243.1 84 244 84.01 244 84L244 84zM255.1 163.9L210.1 117.1C188.4 96.28 157.6 86.4 127.3 91.44C81.55 99.07 48 138.7 48 185.1V190.9C48 219.1 59.71 246.1 80.34 265.3L256 429.3L431.7 265.3C452.3 246.1 464 219.1 464 190.9V185.1C464 138.7 430.4 99.07 384.7 91.44C354.4 86.4 323.6 96.28 301.9 117.1L255.1 163.9z"/></svg>
  </span>

</span>
        <span id="button_likes_text">&nbsp;Like</span>
    </button>
</span>
  

  
  
</div>







    </div>

    
    
    
    
    

    

    
      
      
        
        
<div class="flex author">
  
    
    
      
    
    
      
        
      
      <img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width="96" height="96"
      alt="Utkarsh Deoli" src="/20131113_054558_hu3c0fbd01a0e6baca8802d02a563621ff_1368799_192x192_fill_q75_box_center.jpg" />
    
  
  <div class="place-self-center">
    
    <div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      Author
    </div>
    <div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      Utkarsh Deoli
    </div>
    
    
    <div class="text-sm text-neutral-700 dark:text-neutral-400">Utkarsh Deoli -just a developer for fun</div>
    
    <div class="text-2xl sm:text-lg">
  <div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="mailto:utkarsh.deoli@gmail.com?subject=Contacting%20from%20your%20website"
          target="_blank"
          aria-label="Envelope"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48H48zM0 176V384c0 35.3 28.7 64 64 64H448c35.3 0 64-28.7 64-64V176L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z"/></svg>
  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://github.com/UtkarshDeoli"
          target="_blank"
          aria-label="Github"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentColor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.linkedin.com/in/utkarshdeoli"
          target="_blank"
          aria-label="Linkedin"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentColor" d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://x.com/utkarshdeoli"
          target="_blank"
          aria-label="X-Twitter"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.youtube.com/@utkarshdeoli"
          target="_blank"
          aria-label="Youtube"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentColor" d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z"/></svg>

  </span>

</span></a
        >
      
    
      
        <a
          class="px-1 hover:text-primary-700 dark:hover:text-primary-400"
          href="https://www.leetcode.com/sagemodeutkarsh"
          target="_blank"
          aria-label="Code"
          rel="me noopener noreferrer"
          ><span class="inline-block align-text-bottom">

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512">
<path fill="currentColor"  d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6zm80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3L562.7 256l-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3z"/></svg>
  </span>

</span></a
        >
      
    
  </div>

</div>
  </div>
</div>

      

      

      
      <div class="mb-5"></div>
      

    

  </header>
  
  <section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
    
    

      <div class="min-w-0 min-h-0 max-w-fit">
        
        


        <div class="article-content max-w-prose mb-20">
          

<h2 class="relative group">整体架构 
    <div id="%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>TiDB 大体可以分为三个模块TiDB Server, PD Cluster 和 Storage Cluster。</p>
<ul>
<li>
<p><strong>TiDB Server</strong> 的功能类似于Mysql中的Server端，用于 <u><em>处理客户端的连接</em></u>、<u><em>解析和优化SQL语句</em></u>、<u><em>生成执行计划</em></u> 等等。除此之外，因为TiDB底层存储是LSM-Tree而不是B+ Tree，所以还需要将<u><em>关系型数据转换成KV格式</em></u>。此外还有<u><em>GC</em></u>、<u><em>DDL执行</em></u>、<u><em>缓存</em></u>和<u><em>热点小表</em></u>等功能。</p>
</li>
<li>
<p><strong>PD Cluster</strong> 是 TiDB 相比于传统数据库独有的一个模块，这个模块也是 TiDB 作为分布式系统的核心。主要的功能有<u><em>元数据的存储</em></u>、TiDB 集群中<u><em>微服务的注册和调用</em></u>、分布式事务/全局ID(<u><em>TSO</em></u>)的生成 和 集群的<u><em>负载均衡</em></u>。为了实现这些，PD集成了 <strong>etcd</strong>。</p>
</li>
<li>
<p>Storage Cluster 是TiDB 的存储模块，为了实现 <strong>HTAP</strong>(OLAP + OLTP)，这部分又被分成两个存储模块——<strong>TiKV</strong>(行式存储) 和 <strong>TiFlash</strong> (列式存储)。</p>
<p>TiKV 为了支持OLTP业务，类似传统数据库引擎会有MVCC多版本并发管理、锁机制、算子下堆、事务隔离、ACID等等功能，底层的存储结构使用的是rocksdb实现的LSM-Tree。</p>
<p>TiFlash 是为了支持OLAP业务，TiFlash的数据是基于TiKV异步复制过来的。</p>
</li>
</ul>
<p>




  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img/TiDB%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84.png" alt="Untitled.png" />
      
    </figure>
  

</p>


<h2 class="relative group">分模块梳理 
    <div id="%E5%88%86%E6%A8%A1%E5%9D%97%E6%A2%B3%E7%90%86" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%88%86%E6%A8%A1%E5%9D%97%E6%A2%B3%E7%90%86" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>上面我们对三个模块进行了梳理，下面我们具体剖开每个模块，看看具体的细节</p>


<h3 class="relative group">TiDB Server 
    <div id="tidb-server" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tidb-server" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>




  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img/TiDB%20Server.jpeg" alt="TiDB Server.jpeg" />
      
    </figure>
  

</p>


<h4 class="relative group">编译、优化、执行 
    <div id="%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96%E6%89%A7%E8%A1%8C" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96%E6%89%A7%E8%A1%8C" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<ul>
<li>
<p><code>Protocol Layer</code> 是协议层，用于管理客户端的连接和身份认证</p>
</li>
<li>
<p>SQL的解析和编译是 <code>Parse</code> 和 <code>Compile</code> 模块处理的，主要的作用是：SQL → AST语法树 → 执行计划(Plan)</p>
<p><code>Parse</code> 模块会将SQL语句解析成AST语法树，AST语法树是<code>pkg/parser/ast</code> 目录中定义的基于 <strong>Node</strong> 的一组用于存储SQL语句信息的对象，比如 DMLNode对象中会包含读写字段(FieldList)、表名(TableName)、条件信息(OnCondition)等等。</p>
<p><code>Compile</code> 模块会将 AST语法树转换成执行计划(<strong>SQL Plan</strong>)，这部分对应的代码在<code>pkg/planner</code> 目录下，Plan 对象会根据 ast.Node 即AST语法树来生成，并在创建Plan的过程中会进行<u><em>验证</em></u>、<u><em>逻辑优化</em></u> 和 <u><em>物理优化</em></u>，也会创建对应的session上下文。</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 32C114.6 32 .0272 125.1 .0272 240c0 49.63 21.35 94.98 56.97 130.7c-12.5 50.37-54.27 95.27-54.77 95.77c-2.25 2.25-2.875 5.734-1.5 8.734C1.979 478.2 4.75 480 8 480c66.25 0 115.1-31.76 140.6-51.39C181.2 440.9 217.6 448 256 448c141.4 0 255.1-93.13 255.1-208S397.4 32 256 32z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >还有一点需要注意，<code>Compile</code> 模块中提供了将Plan对象转为对应存储类型(StoreType)的执行器(Executor)，在执行器中包含KV结构数据，即<code>Compile</code> 模块会将解析SQL生成的关系型数据转换成对应的KV结构数据。</span>
</div>

</li>
</ul>


<div id="gallery-f5b649c7b075e6b989981d5ca7e918f4" class="gallery">
  
<img src="img/ast.Node.jpeg" class="grid-w50 " />
<img src="img/SQL%20Plan2.jpeg" class="grid-w50 " />
<img src="img/SQL%20Plan1.jpeg" class="grid-w50 " />

</div>
<ul>
<li>
<p>经过上面的解析和编译 ，我们来到了执行<code>Executor</code>模块，它更像是一个 TiDB Server 中的调度模块，用于调度 <code>Transaction</code>、<code>KV</code> 和 <code>DistSQL</code> 模块。</p>
<p>每个 Exec 中会包含对应的 从Plan计划中传递过来的 session 上下文 (sessionctx)，session中会包含事务管理器(TxnManager)的调用方法，以便在执行过程中管理事务。</p>
<p>事务具体的实现都是封装在 <code>Transaction</code> 模块，对应代码中则是在 <code>pkg/sessiontxn</code> 目录下。</p>
<p>拿到 Executor 后，之后就是具体的执行阶段，针对比较简单的仅 <u><em>根据主键或者唯一索引的等值查询</em></u> 都是通过 <code>KV</code> 模块处理的；相对复杂的任务(job)会通过 <code>DistSQL</code> 将其转换成基于单表的子任务(subjob)。</p>
<p>不论是<code>KV</code>还是 <code>DistSQL</code> 最终都会通过调用<code>TiKV Client</code> 来获取引擎层的数据。</p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 32C114.6 32 .0272 125.1 .0272 240c0 49.63 21.35 94.98 56.97 130.7c-12.5 50.37-54.27 95.27-54.77 95.77c-2.25 2.25-2.875 5.734-1.5 8.734C1.979 478.2 4.75 480 8 480c66.25 0 115.1-31.76 140.6-51.39C181.2 440.9 217.6 448 256 448c141.4 0 255.1-93.13 255.1-208S397.4 32 256 32z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    ><code>Executor</code>模块既然负责了执行的调度，那有关 <strong>算子下推</strong> 的调度也是在此模块做的。具体的代码在<code>pkg/executor/coprocessor.go</code></span>
</div>

<p><strong>算子下推</strong> 指的是将一部分函数计算交给引擎层(TiKV和TiFlash)，以减轻Server层和引擎层在网络IO上的开销，它将本需要Server层处理的工作交给了引擎层，Server层只需要对引擎层的结果进行聚合即可。由此可见，为了支持算子下推，引擎层也需要支持一部分函数执行。</p>
<ul>
<li>TiKV可以支持 TopN 和 Limit 的算子下推</li>
<li>TiFlash可以支持 TableScan、Selection、Hash/Stream Aggregation、TopN、Limit、Project、HashJoin、Windows等算子，支持了几乎所有的SQL函数的下推</li>
</ul>
</li>
</ul>


<div id="gallery-82ac2fbc8d3e34f5f132471c48c9828f" class="gallery">
  
<img src="img/Executor.jpeg" class="grid-w50 " />

<img src="img/Executor2.jpeg" class="grid-w50 " />

</div>


<h4 class="relative group"><strong>online DDL</strong> 
    <div id="online-ddl" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#online-ddl" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p><strong>online DDL</strong> 相关模块——<code>start job</code>, <code>workers</code> 和 <code>schema load</code></p>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 32C114.6 32 .0272 125.1 .0272 240c0 49.63 21.35 94.98 56.97 130.7c-12.5 50.37-54.27 95.27-54.77 95.77c-2.25 2.25-2.875 5.734-1.5 8.734C1.979 478.2 4.75 480 8 480c66.25 0 115.1-31.76 140.6-51.39C181.2 440.9 217.6 448 256 448c141.4 0 255.1-93.13 255.1-208S397.4 32 256 32z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >online DDL 仅在TiDB v6.2.0之前有效，这之后采取了并发DDL框架，详见 <a href="https://docs.pingcap.com/zh/tidb/stable/ddl-introduction"   target="_blank">
    DDL 语句的执行原理及最佳实践</a></span>
</div>

<ul>
<li>TiDB Server集群中所有实例的<code>start job</code> 模块都可以接收DDL语句，并将其放入 TiKV 中的 <code>job queue</code></li>
<li>在 TiDB Server 的集群中，只有一个 Leader节点，也可以称为 Owner 节点，只有Owner节点的<code>workers</code> 模块会生效，从TiKV中获取持久化的队列( <em><strong>物理DDL</strong></em>队列<code>general job queue</code> 和 <em><strong>逻辑DDL</strong></em>队列<code>add index job queue</code>)，执行job，并在直接结束后记录到历史队列 <code>history queue</code></li>
<li><code>schema load</code> 是 TiDB 中表结构schema的缓存，主要用于DDL语句的查询</li>
</ul>
<p>




  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img%2FOnlineDDL.png" alt="OnlineDDL.png" />
      
    </figure>
  

</p>


<h4 class="relative group">缓存 
    <div id="%E7%BC%93%E5%AD%98" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E7%BC%93%E5%AD%98" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<ul>
<li>
<p>缓存模块——<code>memBuffer</code> 和 <code>cache table</code></p>
<p>TiDB Server的缓存主要是存储在 <code>membuffer</code> 模块，会缓存下面三个数据：SQL结果、线程缓、元数据和统计数据，可以通过<strong>tidb_mem_quota_query</strong>阈值参数限制每条SQL的缓存占用大小，如果超过此阈值，可以通过<strong>oom-action</strong>参数设置返回ERROR或打印日志等oom动作。</p>
<p><code>cache table</code> 主要是用于<em>热点小表缓存</em>，此功能主要用于<strong>查询频繁</strong>、<strong>数据量不大</strong>、<strong>极少修改</strong>的场景，因此想使用热点小表的功能需要满足以下几个条件：</p>
<ol>
<li>表的总数据量不大 (小于64M)</li>
<li>表的读取频繁 (查询频繁、数据量小、极少修改)</li>
<li>不做DDL，热点小表支持DDL操作，进行DDL需要先关闭热点小表缓存</li>
</ol>

  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 32C114.6 32 .0272 125.1 .0272 240c0 49.63 21.35 94.98 56.97 130.7c-12.5 50.37-54.27 95.27-54.77 95.77c-2.25 2.25-2.875 5.734-1.5 8.734C1.979 478.2 4.75 480 8 480c66.25 0 115.1-31.76 140.6-51.39C181.2 440.9 217.6 448 256 448c141.4 0 255.1-93.13 255.1-208S397.4 32 256 32z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >针对极少的写场景，热点小表缓存如何保证一致性？                                                                 设定 <strong>缓存租约</strong> 参数 tidb_table_cache_lease ，默认5s。① 租约时间内，读操作直接读缓存，无法进行写操作 ② 租约到期时，缓存中的数据过期，写操作不在堵塞，读写操作都直接请求TiKV ③ 数据更新完毕后后，租约继续开启，回到步骤1</span>
</div>

</li>
</ul>


<h4 class="relative group">GC 
    <div id="gc" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#gc" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<ul>
<li>
<p>GC机制——GC主要是清理 TiKV 中由 MVCC 产生的历史版本。GC操作是仅由TiDB Server集群中 <u><strong>Leader节点</strong></u> 发起，执行GC前，Server会找到一个safe point，小于safe point 时间的数据将会被请求，默认是safe point是当前减去十分钟，可以通过 <strong>GC Left Time</strong> 设定，即 GC Left Time 默认是10分钟。</p>
<p>TiDB Server集群每10分钟会进行一次GC操作。首先清除 <u><em>表或者字段被drop</em></u> 的数据，其次清除<u><em>被delete的数据</em></u>，最后清除这些数据相关的 <u><em>锁信息</em></u>。</p>
</li>
</ul>


<h3 class="relative group">PD 
    <div id="pd" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#pd" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>前面说到PD是TiDB分布式集群的大脑，提供的能力主要是服务整体集群的分布式一致性、高可用。PD是基于<code>etcd</code>实现的，主要的功能大体可以分为以下几类：</p>
<ul>
<li>分布式集群中唯一键的生成：TSO的生成、全局和事务ID的生成</li>
<li>数据存储：存储集群中的服务信息(元数据)、集群中的调度信息</li>
<li>负载均衡策略：集群中的调度规则、标签(label)能力</li>
</ul>


<h4 class="relative group"><strong>数据存储</strong> 
    <div id="%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>PD会记录集群中每个实例的元数据信息、TiDB 集群的环境变量信息(如Server中的GC Left time)、集群的调度信息、使用过的TSO、规则信息、资源组等等。具体是通过 <code>leveldb</code> 存储的。





  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img%2FStorage.jpeg" alt="Storage.jpeg" />
      
    </figure>
  

</p>


<h4 class="relative group"><strong>TSO 的生成</strong> 
    <div id="tso-%E7%9A%84%E7%94%9F%E6%88%90" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tso-%E7%9A%84%E7%94%9F%E6%88%90" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>TSO是一个 int64的整数型，主要是由 <code>physical</code> (unix时钟，精确到毫秒) 和 <code>logical</code> (逻辑相对时钟) 组成，TSO的分配都是由PD集群中的 <u><strong>Leader 节点</strong></u> 分配的。TiDB Server 在请求PD 获取 TSO的时候是调用Leader节点，通过<u><strong>异步 callable-future</strong></u> 的方式获取的，避免了PD生成TSO的等待时间。</p>
<p>

<div id="gallery-cb41507fd8e4327cccd026ba7f1a44c3" class="gallery">
  
<img src="img/TSO%E7%BB%93%E6%9E%84%E5%AE%9A%E4%B9%89.jpeg" class="grid-w50 " />
<img src="img/%E8%AF%B7%E6%B1%82TSO.png" class="grid-w50 " />

<img src="img/GlobalTSOAllocator.jpeg" class="grid-w50 " />

</div>
还需要注意一点的是， PD在分配TSO的时候会对TSO进行落盘，即会产生IO操作，所以在分配过程中会分配 <strong>一段时间窗口</strong> 的TSO并缓存到内存，在TiDB Server 多次获取的过程中，只需要从内存中获取TSO即可，大大增加了并发性。源码在 <a href="https://github.com/tikv/pd"   target="_blank">
    pd</a> 的<code>pkg/tso/global_allocator.go</code></p>


<h4 class="relative group"><strong>负载均衡</strong> 
    <div id="%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>对于负载均衡所需要的实例状态信息，由TiKV节点周期性地通过心跳(heart beat)的方式传递给PD。其中这部分信息包含 <strong>store heartbead</strong>(TiKV实例的状态信息) ****和 <strong>region heartbeat</strong> (TiKV中每个Region的状态信息)。</p>
<p>基于这些信息，PD支持读写均衡、region容量分配均衡、热点数据打散、扩容缩容、故障恢复等等功能，这些属于比较常规的负载均衡策略，这里不做详细说明。下面主要说明一下PD提供的 <em>label 标签</em> 功能。</p>
<p>针对大规模的分布式集群业务，服务会部署在不同的IDC机房、不同的子网上，为了提供用户对于跨机房业务的调度配置，TiDB 在 PD 中提供了 label，具体的代码在<code>pkg/schedule/labeler</code></p>


<div id="gallery-484a5b76979d0d7c4a6bfba77d0c314c" class="gallery">
  
<img src="img/ReplicationConfig.jpeg" class="grid-w50 " />
<img src="img/label.jpeg" class="grid-w50 " />

</div>
<p>PD 中定义了ReplicationConfig来读取label相关的配置，比较重要的几个变量有：</p>
<ul>
<li>max-replicas：每个区域的副本数</li>
<li>location-labels：标签列表，列表中的顺序代表标签的优先级</li>
<li>isolation-level：显式强制隔离副本的label，即在此配置中的label key至少在3个不同的label value中有副本</li>
</ul>


<h3 class="relative group">TiKV 
    <div id="tikv" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tikv" aria-label="Anchor">#</a>
    </span>        
    
</h3>


<h4 class="relative group"><strong>rocksdb</strong> 
    <div id="rocksdb" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#rocksdb" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>TiKV的存储数据结构是基于<a href="https://github.com/facebook/rocksdb"   target="_blank">
    <code>rocksdb</code></a> 的 LSM-Tree (全称是 <em>Log-Structured Merge</em>-<em>tree</em>)，存储的格式是KV键值对，通过分块 + 二分查找的方式找到对应的记录。</p>
<p>LSM-Tree会在内存中分配1个<code>MemTable</code>块和若干个 <code>immutable MemTable</code>，这些块以链表的形式连接在一起；同理磁盘中的 <code>SSTable</code> 也会按照层级串联起来且大小不断递增；需要注意的是 <code>Level 0</code> 的 SSTable 数据是 <code>immutable MemTable</code> 数据的复刻 (rocksdb会尽可能块地将 immutable MemTables 刷盘到 L0的SSTable中)。</p>
<blockquote>
<p>内存中的<code>immutable MemTable</code> = 磁盘中的 <code>Level 0 SSTable</code></p>
</blockquote>
<p>当 <code>MemTable</code> 填满时，会刷盘到<code>immutable MemTable</code>，后台进程会将<code>immutable MemTable</code> 的数据刷新到磁盘中Level 0 的 SSTable ，当Level 0 的SSTABLE文件达到4个时，会进行压缩并存储到Level 1，以此类推。</p>
<p>写操作时，直接将写请求记录在内存的<code>MemTable</code> 和磁盘的 <code>WAL</code> 日志即可</p>
<p>读操作时，TiKV在 MemTable 上有提供了一个<code>Block Cache</code> 的缓存，用于缓存最近最常读取的数据，<code>Block Cache</code> 中没有再依次读取<code>MemTable</code>、<code>immutable MemTable</code>、<code>SSTable</code></p>
<p>还需要注意一点数据写入都是到内存的MemTable，那么如何保证一致性？</p>
<p>答案是：WAL —— <code>Write Ahead Log</code></p>
<p>




  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img%2Frocks%20db.png" alt="rocks db.png" />
      
    </figure>
  


既然 LSM-Tree 是KV形式存储，那么一个表中的不同索引要怎么查找？</p>
<p>这里就需要引入<strong>列簇Column Families</strong>，即每个column对应一组<code>MemTable</code>、<code>immutable MemTable</code>和<code>SSTable</code>。</p>
<p>下面我们从 rocksdb 源码的数据结构，来串一下上面的功能</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="c1">// [db/column_family.h]
</span></span></span><span class="line"><span class="cl"><span class="c1">// 列簇集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">ColumnFamilySet</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	  <span class="k">friend</span> <span class="k">class</span> <span class="nc">ColumnFamilyData</span><span class="p">;</span> <span class="c1">// 默认主键列簇
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// 列簇集合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">UnorderedMap</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="o">&gt;</span> <span class="n">column_families_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">UnorderedMap</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="p">,</span> <span class="n">ColumnFamilyData</span><span class="o">*&gt;</span> <span class="n">column_family_data_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// [db/column_family.h]
</span></span></span><span class="line"><span class="cl"><span class="c1">// 单列簇数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">ColumnFamilyData</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">	  <span class="k">friend</span> <span class="k">class</span> <span class="nc">ColumnFamilySet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 列信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="kt">uint32_t</span> <span class="n">id_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 版本信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="n">Version</span><span class="o">*</span> <span class="n">dummy_versions_</span><span class="p">;</span>  <span class="c1">// Head of circular doubly-linked list of versions.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="n">Version</span><span class="o">*</span> <span class="n">current_</span><span class="p">;</span>         <span class="c1">// == dummy_versions-&gt;prev_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">		<span class="n">MemTable</span><span class="o">*</span> <span class="n">mem_</span><span class="p">;</span> <span class="c1">// MemTable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="n">MemTableList</span> <span class="n">imm_</span><span class="p">;</span> <span class="c1">// immutable MemTable
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	  <span class="n">SuperVersion</span><span class="o">*</span> <span class="n">super_version_</span><span class="p">;</span> <span class="c1">// 所有版本(当前+历史版本)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	
</span></span><span class="line"><span class="cl">		<span class="c1">// ColumnFamily 形成双向链表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="n">ColumnFamilyData</span><span class="o">*</span> <span class="n">next_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">ColumnFamilyData</span><span class="o">*</span> <span class="n">prev_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// [db/memtable_list.h]
</span></span></span><span class="line"><span class="cl"><span class="c1">// 所有 immutable memtables 的集合的引用，数组存在 MemTableListVersion 中
</span></span></span><span class="line"><span class="cl"><span class="c1">// 官方注释也说明 MemTableList即imm 会尽快刷新到 L0 的SST中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">MemTableList</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">const</span> <span class="kt">int</span> <span class="n">min_write_buffer_number_to_merge_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">MemTableListVersion</span><span class="o">*</span> <span class="n">current_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 仍需刷盘的elements数量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">int</span> <span class="n">num_flush_not_started_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 当前内存使用量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">size_t</span> <span class="n">current_memory_usage_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// [db/memtable_list.h]
</span></span></span><span class="line"><span class="cl"><span class="c1">// 保存了 immutable memtables 数组
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">MemTableListVersion</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 没有刷盘的 Immutable MemTables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">MemTable</span><span class="o">*&gt;</span> <span class="n">memlist_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 已经落盘的 MemTables
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">std</span><span class="o">::</span><span class="n">list</span><span class="o">&lt;</span><span class="n">MemTable</span><span class="o">*&gt;</span> <span class="n">memlist_history_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// [db/memtable.h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">MemTable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// MemtableRep 里包含了 SkipListRep 和 HashSkipListRep
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="c1">// 具体可以看 [db/memtablerep.h]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">const</span> <span class="n">size_t</span> <span class="n">kArenaBlockSize</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ConcurrentArena</span> <span class="n">arena_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">MemTableRep</span><span class="o">&gt;</span> <span class="n">table_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">MemTableRep</span><span class="o">&gt;</span> <span class="n">range_del_table_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="c1">// flush 相关
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="kt">bool</span> <span class="n">flush_in_progress_</span><span class="p">;</span>  <span class="c1">// started the flush
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">flush_completed_</span><span class="p">;</span>    <span class="c1">// finished the flush
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint64_t</span> <span class="n">file_number_</span><span class="p">;</span>    <span class="c1">// filled up after flush is complete
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">FlushStateEnum</span><span class="o">&gt;</span> <span class="n">flush_state_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>根据上面的数据结构，我们可以得到下面这张图





  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img%2FColumnFamilySet.jpeg" alt="ColumnFamilySet.jpeg" />
      
    </figure>
  

</p>


<h4 class="relative group">分布式事务 (MVCC + 2PC) 
    <div id="%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-mvcc--2pc" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-mvcc--2pc" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>分布式事务的设计思想沿用了 <strong><strong>Google Percolator</strong></strong> (<a href="https://storage.googleapis.com/pub-tools-public-publication-data/pdf/36726.pdf"   target="_blank">
    <u><em>Google.Inc. (2010). Large-scale Incremental Processing Using Distributed Transactions and Notifications.</em></u></a>) 提出的分布式事务，主要分为两部分</p>
<ol>
<li>基于MVCC机制的快照读</li>
<li>事务的两阶段提交 prewrite-commit</li>
</ol>
<p>稍微总结一下 <strong><strong>Percolator</strong></strong> ：</p>
<ul>
<li>
<p>数据结构层面，定义了一种带TSO时间戳的KV格式，其中 key 是行关键字(row)，列关键字(column)，以及时间戳(timestamp)的组合，value 是任意的 byte 数组</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Key:   row:string, column:string,timestamp:int64
</span></span><span class="line"><span class="cl">Value: string
</span></span></code></pre></div></li>
<li>
<p>架构层面分为3个组件：<strong>Client、 TSO</strong> 和 <strong>Bigtable</strong>，其中Client是分布式事务流程的控制者、两阶段提交的协调者，TSO全局唯一且递增的时间戳，Bigtable是持久化的分布式存储</p>
</li>
</ul>
<p>关于Percolator更详细的内容可以看这篇文章，这里不在展开说明—— <a href="http://mysql.taobao.org/monthly/2018/11/02/"   target="_blank">
    <u><em>PolarDB数据库内核月报. 11(2018). Database · 原理介绍 · Google Percolator 分布式事务实现原理解读</em></u></a></p>
<p>对应到TiDB，首先我们需要知道 TiDB 中的KV格式是如何设计的。TiDB为表的每个索引分配了一个索引ID，用<code>IndexId</code>表示。</p>
<p>对于<strong>主键和唯一索引</strong>，可以根据键值key快速定位到对应的 RowID；如果是唯一索引，value对应RowID主键的值，如果是主键则是具体的数据：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Key:   tablePrefix<span class="o">{</span>tableID<span class="o">}</span>_indexPrefixSep<span class="o">{</span>indexID<span class="o">}</span>_indexedColumnsValue
</span></span><span class="line"><span class="cl">Value: RowID
</span></span></code></pre></div><p>对于不需要满足唯一性约束的普通二级索引，一个键值可能对应多行，需要根据键值范围查询对应的 RowID：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Key:   tablePrefix<span class="o">{</span>TableID<span class="o">}</span>_indexPrefixSep<span class="o">{</span>IndexID<span class="o">}</span>_indexedColumnsValue_<span class="o">{</span>RowID<span class="o">}</span>
</span></span><span class="line"><span class="cl">Value: null
</span></span></code></pre></div><p>生成 IndexKey 这部分代码在tidb中的<code>pkg/tablecodec/tablecodec.go</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">var</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">	<span class="nx">tablePrefix</span>     <span class="p">=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="sc">&#39;t&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nx">recordPrefixSep</span> <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;_r&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">indexPrefixSep</span>  <span class="p">=</span> <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;_i&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nx">metaPrefix</span>      <span class="p">=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">{</span><span class="sc">&#39;m&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 生成 index key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="nf">GenIndexKey</span><span class="p">(</span><span class="nx">loc</span> <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Location</span><span class="p">,</span> <span class="nx">tblInfo</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">TableInfo</span><span class="p">,</span> <span class="nx">idxInfo</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">IndexInfo</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">	<span class="nx">phyTblID</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">indexedValues</span> <span class="p">[]</span><span class="nx">types</span><span class="p">.</span><span class="nx">Datum</span><span class="p">,</span> <span class="nx">h</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">Handle</span><span class="p">,</span> <span class="nx">buf</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">(</span><span class="nx">key</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">,</span> <span class="nx">distinct</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// 判断 unique
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="k">if</span> <span class="nx">idxInfo</span><span class="p">.</span><span class="nx">Unique</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">cv</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">indexedValues</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="k">if</span> <span class="nx">cv</span><span class="p">.</span><span class="nf">IsNull</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">distinct</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">				<span class="k">break</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="nf">TruncateIndexValues</span><span class="p">(</span><span class="nx">tblInfo</span><span class="p">,</span> <span class="nx">idxInfo</span><span class="p">,</span> <span class="nx">indexedValues</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 分配定长buf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">key</span> <span class="p">=</span> <span class="nf">GetIndexKeyBuf</span><span class="p">(</span><span class="nx">buf</span><span class="p">,</span> <span class="nx">RecordRowKeyLen</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">indexedValues</span><span class="p">)</span><span class="o">*</span><span class="mi">9</span><span class="o">+</span><span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// table id, 返回 t[tableID]_i
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">key</span> <span class="p">=</span> <span class="nf">appendTableIndexPrefix</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">phyTblID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// index id，返回 t[tableID]_i[indexId]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">key</span> <span class="p">=</span> <span class="nx">codec</span><span class="p">.</span><span class="nf">EncodeInt</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">idxInfo</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// indexedColumnsValue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">key</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">codec</span><span class="p">.</span><span class="nf">EncodeKey</span><span class="p">(</span><span class="nx">loc</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">indexedValues</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">err</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">!</span><span class="nx">distinct</span> <span class="o">&amp;&amp;</span> <span class="nx">h</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// 二级索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="c1">// RowID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">h</span><span class="p">.</span><span class="nf">IsInt</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">key</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">codec</span><span class="p">.</span><span class="nx">IntHandleFlag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nx">key</span> <span class="p">=</span> <span class="nx">codec</span><span class="p">.</span><span class="nf">EncodeInt</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nf">IntValue</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="nx">key</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">h</span><span class="p">.</span><span class="nf">Encoded</span><span class="p">()</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>在MVCC的加持下，会在Key中记录 version 信息，，例如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Key1_Version1 -&gt; Value
</span></span><span class="line"><span class="cl">Key2_Version2 -&gt; Value
</span></span><span class="line"><span class="cl">Key2_Version1 -&gt; Value
</span></span></code></pre></div><p>当然这部分也是基于上面提到的 <code>GenIndexKey</code> 方法上，添加TSO时间戳；这部分代码在tidb的<code>pkg/store/helper/helper.go</code> ，但实际获取mvcc的 key 是通过请求tikv拿到的，因为中间可能会涉及加锁，具体在tikv的<code>src/storage/txn/commands/mvcc_by_key.rs</code> 和 <code>src/storage/mvcc</code>， 这里只展示部分代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// GetMvccByEncodedKeyWithTS get the MVCC value by the specific encoded key, if lock is encountered it would be resolved.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">Helper</span><span class="p">)</span> <span class="nf">GetMvccByEncodedKeyWithTS</span><span class="p">(</span><span class="nx">encodedKey</span> <span class="nx">kv</span><span class="p">.</span><span class="nx">Key</span><span class="p">,</span> <span class="nx">startTS</span> <span class="kt">uint64</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">kvrpcpb</span><span class="p">.</span><span class="nx">MvccGetByKeyResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 构造 tikv 请求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">tikvReq</span> <span class="o">:=</span> <span class="nx">tikvrpc</span><span class="p">.</span><span class="nf">NewRequest</span><span class="p">(</span><span class="nx">tikvrpc</span><span class="p">.</span><span class="nx">CmdMvccGetByKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">kvrpcpb</span><span class="p">.</span><span class="nx">MvccGetByKeyRequest</span><span class="p">{</span><span class="nx">Key</span><span class="p">:</span> <span class="nx">encodedKey</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">		<span class="nx">kvResp</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nx">Store</span><span class="p">.</span><span class="nf">SendReq</span><span class="p">(</span><span class="nx">bo</span><span class="p">,</span> <span class="nx">tikvReq</span><span class="p">,</span> <span class="nx">keyLocation</span><span class="p">.</span><span class="nx">Region</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">		<span class="nx">mvccResp</span> <span class="o">:=</span> <span class="nx">kvResp</span><span class="p">.</span><span class="nx">Resp</span><span class="p">.(</span><span class="o">*</span><span class="nx">kvrpcpb</span><span class="p">.</span><span class="nx">MvccGetByKeyResponse</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">		<span class="o">...</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="c1">// Try to resolve the lock and retry mvcc get again if the input startTS is a valid value.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>		<span class="k">if</span> <span class="nx">startTS</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">mvccResp</span><span class="p">.</span><span class="nx">Info</span><span class="p">.</span><span class="nf">GetLock</span><span class="p">()</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">			<span class="o">...</span>
</span></span><span class="line"><span class="cl">			<span class="nx">lockInfo</span> <span class="o">:=</span> <span class="nx">mvccResp</span><span class="p">.</span><span class="nx">Info</span><span class="p">.</span><span class="nf">GetLock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">			<span class="nx">lock</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">txnlock</span><span class="p">.</span><span class="nx">Lock</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Key</span><span class="p">:</span>             <span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">encodedKey</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">				<span class="nx">Primary</span><span class="p">:</span>         <span class="nx">lockInfo</span><span class="p">.</span><span class="nf">GetPrimary</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">				<span class="nx">TxnID</span><span class="p">:</span>           <span class="nx">lockInfo</span><span class="p">.</span><span class="nf">GetStartTs</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">				<span class="nx">TTL</span><span class="p">:</span>             <span class="nx">lockInfo</span><span class="p">.</span><span class="nf">GetTtl</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">				<span class="nx">TxnSize</span><span class="p">:</span>         <span class="nx">lockInfo</span><span class="p">.</span><span class="nf">GetTxnSize</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">				<span class="nx">LockType</span><span class="p">:</span>        <span class="nx">lockInfo</span><span class="p">.</span><span class="nf">GetType</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">				<span class="nx">UseAsyncCommit</span><span class="p">:</span>  <span class="nx">lockInfo</span><span class="p">.</span><span class="nf">GetUseAsyncCommit</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">				<span class="nx">LockForUpdateTS</span><span class="p">:</span> <span class="nx">lockInfo</span><span class="p">.</span><span class="nf">GetForUpdateTs</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">			<span class="p">}</span>
</span></span><span class="line"><span class="cl">			<span class="o">...</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="k">return</span> <span class="nx">mvccResp</span><span class="p">,</span> <span class="kc">nil</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>	
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-rust" data-lang="rust"><span class="line"><span class="cl"><span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">storage</span>::<span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">mvcc</span>::<span class="n">MvccReader</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">txn</span>::<span class="p">{</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">commands</span>::<span class="p">{</span><span class="n">find_mvcc_infos_by_key</span><span class="p">,</span><span class="w"> </span><span class="n">Command</span><span class="p">,</span><span class="w"> </span><span class="n">CommandExt</span><span class="p">,</span><span class="w"> </span><span class="n">ReadCommand</span><span class="p">,</span><span class="w"> </span><span class="n">TypedCommand</span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">ProcessResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Result</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">},</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">types</span>::<span class="n">MvccInfo</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">Snapshot</span><span class="p">,</span><span class="w"> </span><span class="n">Statistics</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">};</span><span class="w">
</span></span></span></code></pre></div>
  



<div
  
    class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"
  >

  <span
    
      class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"
    >

    

  <span class="relative block icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentColor" d="M256 32C114.6 32 .0272 125.1 .0272 240c0 49.63 21.35 94.98 56.97 130.7c-12.5 50.37-54.27 95.27-54.77 95.77c-2.25 2.25-2.875 5.734-1.5 8.734C1.979 478.2 4.75 480 8 480c66.25 0 115.1-31.76 140.6-51.39C181.2 440.9 217.6 448 256 448c141.4 0 255.1-93.13 255.1-208S397.4 32 256 32z"/></svg>

  </span>


  </span>

  <span
    
      class="dark:text-neutral-300"
    >总结一下上面的内容，key的生成是在 TiDB Server 中完成的，然后TiDB Server拿到了TSO后(startTs)，会请求TiKV获取MVCC的信息</span>
</div>

<p>前面用大量篇幅说了TiDB的key生成和TiKV中MVCC key，下面讲一下 2PC流程。</p>
<p>2PC流程会涉及到 <strong>乐观锁</strong> 和 <strong>悲观锁</strong>，最主要的区别在于悲观锁会<u>在用户发起2PC前(执行阶段)，请求 TiKV 获取并持久化一个悲观锁</u>(for updata ts)，具体流程如下：</p>
<ol>
<li>
<p>用户开启事务，TiDB请求 PD 获取 <code>start_ts</code></p>
</li>
<li>
<p>用户执行SQL，通过<code>start_ts</code> 从TiKV获取数据，并写入TiDB内存</p>
</li>
<li>
<p><u><em>从 PD 获取当前 tso 作为当前锁的 for_update_ts，并将锁信息写入内存</em></u> (悲观锁)</p>
</li>
<li>
<p><u><em>使用 <code>for_update_ts</code> 并发地对所有涉及到的 Key 发起加悲观锁（acquire pessimistic lock）请求 (悲观锁)</em></u></p>
</li>
<li>
<p>用户发起提交，TiDB Server开启两阶段提交</p>
</li>
<li>
<p><strong>prewrite</strong>：TiDB 请求TiKV 将数据写入 MemTable，并写入start_ts</p>
<p><strong>commit</strong>：TiDB 从 PD 获取 TSO，作为 <code>commit_ts</code>；请求TiKV，并给写入数据添加 <code>commit_ts</code></p>
</li>
</ol>
<p>最后推荐一下 TiDB  社区的专栏文章 (<a href="https://tidb.net/blog/7730ed79"   target="_blank">
    <em>TiDB 悲观锁实现原理 2021.06.21</em></a>)</p>
<p>




  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img/%E6%82%B2%E8%A7%82%E9%94%81%E5%92%8C%E4%B9%90%E8%A7%82%E9%94%81.png" alt="Untitled" />
      
    </figure>
  

</p>


<h4 class="relative group">Region 
    <div id="region" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#region" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>前面我们讲到了相对微观的持久化的结构、事务等等，现在我们再从相对宏观的角度再来看整个 TiKV 集群。</p>
<p>TiDB 中每个表会对应多个 Region，Region划分的规则是</p>
<ul>
<li>Region达到96M后，会另起一个Region</li>
<li>对于历史数据的写入，会导致原已</li>
<li>达到96M的Region增大/减小
<ul>
<li>如果Region增加到144M后，一个Region会分裂成两个Region</li>
<li>如果Region过小时，Region会做合并</li>
</ul>
</li>
</ul>
<p>TiKV 集群中，每个Region至少会有3个副本 (1个leader 2个follower)，TiDB只和leader节点进行通信，leader和follower之间是通过 Raft 协议同步的，所以和 Raft 协议类似：</p>
<ul>
<li>leader会定期(<u><em>heartbeat time internal</em></u>)向 follower发起心跳，并将写日志同步到follower</li>
<li>如果一定时间内(<u><em>election timeout</em></u>) follower没收到心跳，会将自己的状态转为 candidate候选人</li>
</ul>
<p>




  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img/TiKV%20Region%20Group.png" alt="TiKV Region Group.png" />
      
    </figure>
  


leader和 follower 之间的写日志同步是基于<code>raft log</code> 的，和 <code>rocksdb kv</code> 存放数据不同，<code>rocksdb raft</code> 仅存放 <code>raft log</code>，同步具体分为3步：</p>
<ol>
<li>Propose：当 Region leader 收到写请求的时候，leader会将写请求变成 <code>raft log</code></li>
<li>Append：将 raft log 写入到本地的 <code>rocksdb raft</code> 进行持久化</li>
<li>Replicate：leader 通过 raft 算法，将自己的日志复制到 follower，follower收到日之后写入到自己本地的<code>rocksdb raft</code> ，最后 follower将成功的消息返回给leader</li>
<li>Committed：当leader收到收到过半数发送的成功消息后，则完成commit</li>
</ol>
<p>这里的commit不是指2PC中的commit阶段完成，而只是raft日志复制完成，实际上raft复制这一步是在2PC第二部commit中的一个步骤，raft日志复制完成后，2PC的commit操作才能完成。</p>


<h3 class="relative group">TiFlash 
    <div id="tiflash" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#tiflash" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>TiFlash是负责列式存储的模块，主要的核心功能如下：</p>
<ul>
<li>异步复制：TiFlash数据来源</li>
<li>一致性：TiFlash中的MVCC快照读</li>
<li>智能选择：TiDB 自动选择 TiKV或者TiFlash 混用以提供最佳的查询速度，这也是HTAP的特性之一</li>
<li>计算加速：这部分主要是算子下推的功能，之前在介绍TiDB的时候也有所涉及</li>
</ul>


<h4 class="relative group">异步复制 
    <div id="%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>在对TiDB集群进行写入的过程中，并不会直接写TiFlash，也不会像TiKV的 follower 节点那样在写入的时候通过日志复制保持强一致性。TiFlash 是作为 <code>raft learner</code> 角色对TiKV中的数据进行<strong>异步复制</strong>。</p>
<p>步骤如下：</p>
<ol>
<li>同一个集群内的TiDB会维护一个TiFlash Replica Manager (注：此TiFlash Replica Manager功能在21年12月之前是放在TiFlash中的，之后迁到TiDB Server模块，参考<a href="https://github.com/pingcap/tidb/issues/29924"   target="_blank">
    <u><em>11.18.2021 ddl: Move TiFlash cluster manager module into TiDB</em></u></a>)</li>
<li>当 TiDB 感知到写操作时，会转化为 PD 的 Placement Rule</li>
<li>PD 通过 Placement Rule 令 TiKV 分裂出制定 Key 范围的Region，为其添加 Learner Peer 并异步调度到集群中的TiFlash节点</li>
</ol>
<p>




  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img/TiFlash%E5%BC%82%E6%AD%A5%E5%A4%8D%E5%88%B6.png" alt="Untitled" />
      
    </figure>
  

</p>
<p>下面我们可以看一下部分代码，TiFlash Replica Manager这部分主要在 TiDB 的<code>pkg/domain/infosync/tiflash_manager.go</code> 中，这里定义了 ManagerCtx 的结构</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// 管理 PD 和 TiFlash 副本信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">TiFlashReplicaManagerCtx</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">etcdCli</span>              <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span>
</span></span><span class="line"><span class="cl">	<span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>         <span class="c1">// protect tiflashProgressCache
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">tiflashProgressCache</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int64</span><span class="p">]</span><span class="kt">float64</span>
</span></span><span class="line"><span class="cl">	<span class="nx">codec</span>                <span class="nx">tikv</span><span class="p">.</span><span class="nx">Codec</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">TiFlashReplicaManager</span> <span class="kd">interface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// 维护 PlacementRule
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">SetPlacementRule</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">rule</span> <span class="nx">placement</span><span class="p">.</span><span class="nx">TiFlashRule</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeletePlacementRule</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">group</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">ruleID</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">error</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetGroupRules</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">group</span> <span class="kt">string</span><span class="p">)</span> <span class="p">([]</span><span class="nx">placement</span><span class="p">.</span><span class="nx">TiFlashRule</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// 管理和获取 TiFlash 副本信息
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nf">GetStoresStat</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pd</span><span class="p">.</span><span class="nx">StoresInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">CalculateTiFlashProgress</span><span class="p">(</span><span class="nx">tableID</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">replicaCount</span> <span class="kt">uint64</span><span class="p">,</span> <span class="nx">TiFlashStores</span> <span class="kd">map</span><span class="p">[</span><span class="kt">int64</span><span class="p">]</span><span class="nx">pd</span><span class="p">.</span><span class="nx">StoreInfo</span><span class="p">)</span> <span class="p">(</span><span class="kt">float64</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">UpdateTiFlashProgressCache</span><span class="p">(</span><span class="nx">tableID</span> <span class="kt">int64</span><span class="p">,</span> <span class="nx">progress</span> <span class="kt">float64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">GetTiFlashProgressFromCache</span><span class="p">(</span><span class="nx">tableID</span> <span class="kt">int64</span><span class="p">)</span> <span class="p">(</span><span class="kt">float64</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="nf">DeleteTiFlashProgressFromCache</span><span class="p">(</span><span class="nx">tableID</span> <span class="kt">int64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>

<h4 class="relative group">一致性 
    <div id="%E4%B8%80%E8%87%B4%E6%80%A7" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E4%B8%80%E8%87%B4%E6%80%A7" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>我们知道 TiFlash 的数据是通过异步调度的，但TiDB是支持智能选择的，这就会产生一个问题：如何保证智能选择的时候保证TiFlash和TiKV的数据一致性？</p>
<p>在查询TiFlash的时候，TiFlash会请求TiKV leader节点来确认最新的 <code>raft log idx</code> ，如果自己不是最新的会等待最新的 <code>raft log</code> 同步过来，以保证自己的数据和 TiKV数据的一致性。具体的例子如下：</p>
<ul>
<li>T0 时刻：写入数据到 TiKV Leader</li>
<li>T1 时刻：请求TiFlash获取数据</li>
<li>T2 时刻：TiFlash 请求TiKV leader 获取最新的 <code>raft log idx</code> 并等待当前TiFlash中的 idx 追上，这个步骤也被称为 <em><strong>Learner Read</strong></em></li>
</ul>
<p>




  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img/TiFlash%E4%B8%80%E8%87%B4%E6%80%A7.png" alt="Untitled" />
      
    </figure>
  

</p>


<h4 class="relative group">智能选择 
    <div id="%E6%99%BA%E8%83%BD%E9%80%89%E6%8B%A9" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E6%99%BA%E8%83%BD%E9%80%89%E6%8B%A9" aria-label="Anchor">#</a>
    </span>        
    
</h4>
<p>TiDB可以经由优化器自主选择行列，选择的逻辑是：优化器根据统计信息估算读取数据的规模，并对比列存和行存访问开销，然后做出最优选择。所以这部分是在Cpomplie阶段，即把 <code>AST</code> 语法树转换成<code>SQL Plan</code> 的时候完成的，对应的代码应该是 <code>pkg/planner/core/optimizer.go</code> ，这里就不具体展开了。</p>
<p>




  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img/TiFlash%E6%99%BA%E8%83%BD%E9%80%89%E6%8B%A9.png" alt="Untitled" />
      
    </figure>
  

</p>


<h2 class="relative group">分功能梳理 
    <div id="%E5%88%86%E5%8A%9F%E8%83%BD%E6%A2%B3%E7%90%86" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#%E5%88%86%E5%8A%9F%E8%83%BD%E6%A2%B3%E7%90%86" aria-label="Anchor">#</a>
    </span>        
    
</h2>
<p>我们在上面按服务模块挨个介绍了每个模块中的主要功能，下面这部分主要是想通过 DML和DDL 流程把上面的模块都穿起来。</p>


<h3 class="relative group">DML - 读操作 
    <div id="dml---%E8%AF%BB%E6%93%8D%E4%BD%9C" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#dml---%E8%AF%BB%E6%93%8D%E4%BD%9C" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<ol>
<li>SQL 会被<strong>TiDB Server</strong> 中的<code>Protocol Layer</code> 协议层接收</li>
<li><strong>TiDB Server</strong> 请求 PD 节点获取 TSO，标记为 <code>start_ts</code> 开始执行时间</li>
<li>进入<code>Parse</code> 解析模块，将SQL语句解析为 AST 语法树</li>
<li>将 AST 语法树交给<code>Compile</code> 模块，通过编译优化后，生成对应的<code>SQL Plan</code> 执行计划</li>
<li>SQL Plan 进入<code>Execute</code> 模块，<code>Execute</code> 先去<code>information schema</code> 缓存中获取表的元数据信息。如果是简单的点查，会下发到 <code>kv</code> 模块；如果是相对复杂的任务，会下发到 <code>DistSQL</code> 模块，由它们具体调用 client 请求 <strong>TiKV</strong></li>
<li>读请求到达 <strong>TiKV</strong> 后，会生成 snapshot 快照，进入<code>UnifyRead Pool</code>线程池</li>
<li>TiKV 会从<code>read pool</code>中拿到快照，并请求 <code>rocksdb kv</code> 执行查询</li>
</ol>
<p>




  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img/DML%E8%AF%BB%E6%93%8D%E4%BD%9C.png" alt="Untitled" />
      
    </figure>
  

</p>


<h3 class="relative group">DML - 写操作 
    <div id="dml---%E5%86%99%E6%93%8D%E4%BD%9C" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#dml---%E5%86%99%E6%93%8D%E4%BD%9C" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>前4步和读操作基本类似，这里我们直接从第5步开始</p>
<ol>
<li><code>Execute</code> 模块去 <strong>TiKV</strong> 查询需要修改的数据，此步骤和读操作类似</li>
<li><strong>TiDB Server</strong> 拿到需要修改的原始数据后，将数据更新到 <code>memBuffer</code> 缓存；如果此时发生写冲突，需要请求PD获取 <code>for_update_ts</code> 时间戳 (悲观锁)</li>
<li>用户发起提交后，调用 <code>Transaction</code> 模块发起两阶段提交 (2PC)，写操作都是<code>Transaction</code> 通过<code>KV</code>模块调用<strong>TiKV</strong></li>
<li>写操作会先发送给 <strong>TiKV</strong> 的<code>Scheduler</code>模块，它负责负责协调事务并发写入冲突，并将收到的写请求向下传递给<code>Raftsotre</code></li>
<li><code>Raftsotre</code> 模块拿到请求后会生成 <code>raft log</code> ，将<code>raft log</code>写入本地(<em>leader</em>)的 <code>rocksdb raft</code> 后，同步给 <em>follower</em></li>
<li>当过半follower将<code>raft log</code>写入本地<code>rocksdb raft</code> 并返回成功后，调用Apply模块将数据持久化到 <code>rocksdb kv</code> ，成功后返回 <strong>TiDB Server</strong>，至此2PC 的第一步完成</li>
<li><strong>TiDB Server</strong> 再次请求 PD 获取 <code>commit_ts</code> 提交的TSO，再次调用<strong>TiKV</strong> 写入<code>commit_ts</code></li>
<li>最终将提交成功返回给用户</li>
</ol>
<p>




  
  
  
    <figure>
      <img class="my-0 rounded-md" loading="lazy" src="img/DML%E5%86%99%E6%93%8D%E4%BD%9C.png" alt="Untitled" />
      
    </figure>
  

</p>


<h3 class="relative group">DDL 
    <div id="ddl" class="anchor"></div>
    
    <span
        class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
        <a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700"
            style="text-decoration-line: none !important;" href="#ddl" aria-label="Anchor">#</a>
    </span>        
    
</h3>
<p>之前在TiDB的<code>online DDL</code> 我们讲了相关模块，这里我们主要按照流程步骤描述一下：</p>
<ol>
<li>用户给任一的 <strong>TiDB Server</strong> 发送 DDL 请求</li>
<li>经过解析、编译、优化之后调用<code>start job</code>
<ol>
<li>如果当前的 <strong>TiDB Server</strong> 是 Owner 节点则直接调用<code>workers</code> 执行</li>
<li>否则将DDL 任务持久化到 <strong>TiKV</strong> 的<code>job queue</code>(物理DDL) 或 <code>add index queue</code>(逻辑DDL)。<strong>TiDB Server Owner</strong> 节点的<code>works</code> 模块从 <strong>TiKV</strong> 中的 queue 获取任务并执行</li>
</ol>
</li>
<li>执行完毕后，将历史任务持久化到TiKV的 <code>history queue</code></li>
</ol>
<p>




  
  
    
  
  
    <figure>
      
      <img
        class="my-0 rounded-md"
        loading="lazy"
        srcset="
        /articels/2023-12-01/img/OnlineDDL_hu7d307d227476547321113b4378f98a89_25850_330x0_resize_box_3.png 330w,
        /articels/2023-12-01/img/OnlineDDL_hu7d307d227476547321113b4378f98a89_25850_660x0_resize_box_3.png 660w,
        /articels/2023-12-01/img/OnlineDDL_hu7d307d227476547321113b4378f98a89_25850_1024x0_resize_box_3.png 1024w,
        /articels/2023-12-01/img/OnlineDDL_hu7d307d227476547321113b4378f98a89_25850_1320x0_resize_box_3.png 2x"
        src="/articels/2023-12-01/img/OnlineDDL_hu7d307d227476547321113b4378f98a89_25850_660x0_resize_box_3.png"
        alt="Untitled"
      />
      
      
    </figure>
  

</p>
<p>但是这种方式有几个问题：</p>
<ul>
<li><strong>TiDB Server</strong> 集群中的 Owner节点只有一个，影响执行效率</li>
<li><code>job queue</code>或者<code>add index queue</code> 是先进先出，DDL任务会存在积压的情况</li>
<li>对于互相不影响的DDL任务，在执行的时候依然会被阻塞</li>
</ul>
<p>所以在 <strong>TiDB v6.2</strong> 版本之后，推出了<strong>并发DDL</strong> 的框架</p>
<p>首先针对 Owner 节点添加了判断：</p>
<ul>
<li>涉及一张表的DDL相互阻塞</li>
<li>DROP DATABASE 和 数据库内所有DDL互相阻塞</li>
<li>逻辑 DDL 需要等待之前正在执行的逻辑 DDL 执行完才能执行 (逻辑DDL本身执行较快不怎么消耗资源)</li>
</ul>
<p>在以上的限制后，进行了如下的升级：</p>
<ul>
<li>集群中可以有多个 Owner 并行执行执行 DDL 任务</li>
<li>DDL Job 不再是先进先出，而是通过选择可执行的 Job 集合</li>
</ul>

        </div>
        
        

        
        

          
      </div>
     
      
      
        
        
          
          
        
      <script>
        var oid = "views_articels\/2023-12-01\/index.md"
        var oid_likes = "likes_articels\/2023-12-01\/index.md"
      </script>
      
      
      
      <script type="text/javascript" src="/js/page.min.b06a29d42a4ed16787978e2eee1e8c797b7698db2bc14ccee78f5c80ac566fc996190a73ad80a5e987558474b20b96fa38f7d85b405f165ff72b7b163c5ad11b.js" integrity="sha512-sGop1CpO0WeHl44u7h6MeXt2mNsrwUzO549cgKxWb8mWGQpzrYCl6YdVhHSyC5b6OPfYW0BfFl/3K3sWPFrRGw=="></script>
  
    </section>
  <footer class="pt-8 max-w-prose print:hidden">

    
  
    
    
    
    <div class="pt-8">
      <hr class="border-dotted border-neutral-300 dark:border-neutral-600" />
      <div class="flex justify-between pt-3">
        <span>
          
            <a class="flex group mr-3" href="/articels/2023-10-30/">
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >向量相似性检索方法</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-10-30 00:00:00 &#43;0000 UTC">30 October 2023</time>
                  
                </span>
              </span>
            </a>
          
        </span>
        <span>
          
            <a class="flex text-right group ml-3" href="/articels/2023-12-10/">
              <span class="flex flex-col">
                <span
                  class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"
                  >读书笔记《大规模语言模型：从理论到实践》</span
                >
                <span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
                  
                    <time datetime="2023-12-10 00:00:00 &#43;0000 UTC">10 December 2023</time>
                  
                </span>
              </span>
              <span
                class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400"
                >&rarr;</span
              >
              <span
                class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400"
                >&larr;</span
              >
            </a>
          
        </span>
      </div>
    </div>
  


    
  </footer>
</article>

      <div id="top-scroller" class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0">
  <a href="#the-top"
    class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400"
    aria-label="Scroll to top" title="Scroll to top">
    &uarr;
  </a>
</div>
    </main><footer id="site-footer" class="py-10 print:hidden">
  
  
    
    <nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
      <ul class="flex flex-col list-none sm:flex-row">
        
        <li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
          <a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href=""
            title="">
            
            
          </a>
        </li>
        
      </ul>
    </nav>
    
  
  <div class="flex items-center justify-between">

    
    
    <p class="text-sm text-neutral-500 dark:text-neutral-400">
      &copy;
      2024
      Utkarsh Deoli
    </p>
    

    
    

  </div>
  <script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
  
  
  <script type="text/javascript" src="/js/process.min.62060bb247f4de2b6dde45903668fefb68d792f365587605177b1227c0cf43588701edaca0cb40e2c8e2789bd5ce67c1d2a215b9fb258c3496a7cd25e7cb5fdf.js" integrity="sha512-YgYLskf03itt3kWQNmj&#43;&#43;2jXkvNlWHYFF3sSJ8DPQ1iHAe2soMtA4sjieJvVzmfB0qIVufsljDSWp80l58tf3w=="></script>
  
  
</footer>
  </div>
</body>

</html>
